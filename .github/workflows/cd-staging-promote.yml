name: CD - Staging and Promote

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Immutable image tag (e.g., sha-<commit>)"
        required: true
  push:
    branches:
      - staging-env

env:
  GHCR_OWNER: rutabageldev
  GHCR_REPO: fitfolio

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set IMAGE_TAG
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV
            echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            TAG="sha-$(git rev-parse --short=12 HEAD)"
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
            echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile.prod
          push: true
          tags: |
            ghcr.io/${{ env.GHCR_OWNER }}/${{ env.GHCR_REPO }}/backend:${{ env.IMAGE_TAG }}

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: frontend/Dockerfile.prod
          push: true
          tags: |
            ghcr.io/${{ env.GHCR_OWNER }}/${{ env.GHCR_REPO }}/frontend:${{ env.IMAGE_TAG }}

  deploy-staging:
    name: Deploy to Staging
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}" >> $GITHUB_ENV
      - name: Sync compose files to staging host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGING_SSH_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: "compose.staging.yml,compose.prod.yml"
          target: "${{ secrets.STAGING_APP_DIR }}"
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.STAGING_SSH_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            set -euo pipefail
            export GHCR_OWNER=${{ env.GHCR_OWNER }}
            export GHCR_REPO=${{ env.GHCR_REPO }}
            export IMAGE_TAG=${{ env.IMAGE_TAG }}
            docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
            cd "${{ secrets.STAGING_APP_DIR }}"
            docker compose -f compose.staging.yml pull
            docker compose -f compose.staging.yml up -d
            docker compose -f compose.staging.yml exec -T backend bash -lc "alembic -c /app/alembic.ini upgrade head"

  smoke-staging:
    name: Smoke Tests (Staging)
    needs: deploy-staging
    runs-on: ubuntu-latest
    steps:
      - name: Health check
        run: |
          set -e
          curl -fsS https://staging.fitfolio.rutabagel.com/healthz
      - name: API root check
        run: |
          set -e
          curl -fsS https://staging.fitfolio.rutabagel.com/api

  promote-prod:
    name: Promote to Production (Manual)
    needs: smoke-staging
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://fitfolio.rutabagel.com
    steps:
      - uses: actions/checkout@v4
      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}" >> $GITHUB_ENV
      - name: Sync compose files to prod host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "compose.prod.yml"
          target: "${{ secrets.PROD_APP_DIR }}"
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -euo pipefail
            export GHCR_OWNER=${{ env.GHCR_OWNER }}
            export GHCR_REPO=${{ env.GHCR_REPO }}
            export IMAGE_TAG=${{ env.IMAGE_TAG }}
            docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
            cd "${{ secrets.PROD_APP_DIR }}"
            docker compose -f compose.prod.yml pull
            docker compose -f compose.prod.yml up -d
            docker compose -f compose.prod.yml exec -T backend bash -lc "alembic -c /app/alembic.ini upgrade head"
