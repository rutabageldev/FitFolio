name: CD - Staging and Promote

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Immutable image tag (e.g., sha-<commit>)'
        required: true
      extended_smoke:
        description: 'Run extended auth smoke (/_debug/mail) if enabled'
        required: false
        default: 'false'
      bypass_ci_gate:
        description: 'Bypass CI success requirement (manual runs only)'
        required: false
        default: 'false'
  workflow_run:
    workflows: ['CI']
    branches:
      - main
    types:
      - completed

env:
  GHCR_OWNER: rutabageldev
  GHCR_REPO: fitfolio

jobs:
  require-ci:
    name: Require CI Success
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    # Skip this job only when workflow_dispatch with bypass flag
    if: >
      github.event_name != 'workflow_dispatch' || github.event.inputs.bypass_ci_gate != 'true'
    steps:
      - name: Check workflow_run conclusion (if triggered by workflow_run)
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "CI workflow did not succeed: ${{ github.event.workflow_run.conclusion }}"
            exit 1
          fi
          echo "CI workflow succeeded, proceeding with deployment"

      - name: Check latest CI run for this commit
        if: github.event_name != 'workflow_run'
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;
            const { owner, repo } = context.repo;
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner, repo, per_page: 50, head_sha: sha
            });
            const ciRun = runs.data.workflow_runs.find(r => r.name === "CI" && r.head_sha === sha);
            if (!ciRun) {
              core.setFailed("No CI run found for this commit.");
              return;
            }
            if (ciRun.status !== "completed" || ciRun.conclusion !== "success") {
              core.setFailed(`CI run not successful: status=${ciRun.status} conclusion=${ciRun.conclusion}`);
            } else {
              core.info("CI success verified.");
            }

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    needs: require-ci
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set IMAGE_TAG
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV
            echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            TAG="sha-$(git rev-parse --short=12 HEAD)"
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
            echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile.prod
          push: true
          tags: |
            ghcr.io/${{ env.GHCR_OWNER }}/${{ env.GHCR_REPO }}/backend:${{ env.IMAGE_TAG }}

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: frontend/Dockerfile.prod
          push: true
          tags: |
            ghcr.io/${{ env.GHCR_OWNER }}/${{ env.GHCR_REPO }}/frontend:${{ env.IMAGE_TAG }}

  deploy-staging:
    name: Deploy to Staging
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}" >> $GITHUB_ENV
      - name: Sync stack file to staging host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGING_SSH_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: 2222
          source: 'deploy/stack.staging.yml'
          target: '${{ secrets.STAGING_APP_DIR }}'
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.STAGING_SSH_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: 2222
          script: |
            set -euo pipefail
            export GHCR_OWNER=${{ env.GHCR_OWNER }}
            export GHCR_REPO=${{ env.GHCR_REPO }}
            export IMAGE_TAG=${{ env.IMAGE_TAG }}
            # Login to GHCR using fine-grained read-only token
            docker login ghcr.io -u "${{ secrets.STAGING_GHCR_READ_USER }}" -p "${{ secrets.STAGING_GHCR_READ_TOKEN }}"
            cd "${{ secrets.STAGING_APP_DIR }}"
            # Deploy or update the stack with current IMAGE_TAG
            IMAGE_TAG="${IMAGE_TAG}" docker stack deploy -c stack.staging.yml fitfolio-staging
            # Run DB migrations inside one backend task
            cid=$(docker ps --filter "name=fitfolio-staging_backend" --format '{{.ID}}' | head -n1)
            if [ -n "$cid" ]; then
              docker exec -i "$cid" bash -lc "alembic -c /app/alembic.ini upgrade head"
            else
              echo "No backend container found to run migrations" >&2
              exit 1

  smoke-staging:
    name: Smoke Tests (Staging)
    needs: deploy-staging
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run smoke test script
        run: bash scripts/smoke_deploy.sh "https://staging.fitfolio.rutabagel.com" "${{ github.event.inputs.extended_smoke || 'false' }}"

  promote-prod:
    name: Promote to Production (Manual)
    needs: smoke-staging
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://fitfolio.rutabagel.com
    steps:
      - uses: actions/checkout@v4
      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}" >> $GITHUB_ENV
      - name: Sync compose files to prod host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: 2222
          source: 'compose.prod.yml'
          target: '${{ secrets.PROD_APP_DIR }}'
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: 2222
          script: |
            set -euo pipefail
            export GHCR_OWNER=${{ env.GHCR_OWNER }}
            export GHCR_REPO=${{ env.GHCR_REPO }}
            export IMAGE_TAG=${{ env.IMAGE_TAG }}
            docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
            cd "${{ secrets.PROD_APP_DIR }}"
            docker compose -f compose.prod.yml pull
            docker compose -f compose.prod.yml up -d
            docker compose -f compose.prod.yml exec -T backend bash -lc "alembic -c /app/alembic.ini upgrade head"
