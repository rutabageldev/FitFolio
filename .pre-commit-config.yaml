repos:
  # --- Core hygiene ---
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: check-added-large-files
      - id: check-merge-conflict
      - id: end-of-file-fixer
      - id: trailing-whitespace
      - id: mixed-line-ending
      - id: check-yaml
      - id: check-json

  # --- Python lint & format ---
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.5.6
    hooks:
      - id: ruff
        args: [--fix] # auto-fix where possibl
      - id: ruff-format # code formatter

  # --- Types ---
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.10.0
    hooks:
      - id: mypy
        additional_dependencies:
          ['sqlalchemy>=2.0', 'pydantic>=2', 'types-redis>=4.6.0']

  # --- Security (static) ---
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.9
    hooks:
      - id: bandit
        args: ['-q', '--skip', 'B101']
        exclude: ^backend/tests/

  # --- Dependency vulns ---
  - repo: https://github.com/pypa/pip-audit
    rev: v2.7.3
    hooks:
      - id: pip-audit
        stages: [pre-push]
        args: ['-r', 'backend/requirements.txt']

  # --- Secrets (local) ---
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: |
          (?x)^(
            frontend/node_modules/|
            .*/migrations/|
          )

  # --- Frontend lint & format (run in devcontainer) ---
  - repo: local
    hooks:
      - id: eslint
        name: frontend eslint
        language: system
        entry: bash -lc 'npx --yes eslint --config frontend/eslint.config.cjs --fix --max-warnings=0 -- "$@"' --
        files: ^frontend/.*\.(ts|tsx|js|jsx)$
      - id: prettier-write
        name: frontend prettier write
        language: system
        entry: bash -lc 'npx --yes prettier -w --config frontend/.prettierrc --ignore-path frontend/.prettierignore -- "$@"' --
        files: ^frontend/.*\.(ts|tsx|js|jsx|json|css|scss|md|markdown|ya?ml|html)$

  # --- Backend security tests ---
  - repo: local
    hooks:
      - id: pytest-security
        name: pytest security tests
        language: system
        entry: bash -lc 'cd backend && pytest tests/security/test_security.py tests/security/test_csrf.py tests/security/test_session_rotation.py -v --tb=short'
        pass_filenames: false
        files: ^backend/(app/(core/(security|session_rotation|csrf)|middleware/csrf|api/(routes/auth|deps))|tests/security/test_(security|csrf|session_rotation)\.py)$

  # --- Pre-push checks ---
  - repo: local
    hooks:
      - id: prettier-check
        name: frontend prettier check (pre-push)
        language: system
        entry: bash -lc 'npx --yes prettier -c --config frontend/.prettierrc --ignore-path frontend/.prettierignore -- "$@"' --
        files: ^frontend/.*\.(ts|tsx|js|jsx|json|css|scss|md|markdown|ya?ml|html)$
        stages: [pre-push]
      - id: pytest-all
        name: pytest all tests (pre-push)
        language: system
        entry: bash -lc 'cd backend && pytest -v --tb=short'
        pass_filenames: false
        stages: [pre-push]
